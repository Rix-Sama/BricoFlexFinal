{% extends "shop/base.html" %} 

{% block content %}
<!-- Barre de recherche sur toute la largeur -->
<div class="row">
    <div class="col-12 mt-4 mb-3">
        <form method="get" action="{% url 'home' %}" class="input-group shadow-sm w-100">
            <input type="text" name="q" class="form-control form-control-lg rounded-pill" placeholder="Rechercher un produit..." aria-label="Rechercher un produit">
            <div class="input-group-append">
                <button class="btn btn-primary rounded-pill px-4" type="submit">
                    <i class="fas fa-search"></i> Rechercher
                </button>
            </div>
        </form>
    </div>
</div>
    <!-- Zone d'affichage du message -->
    <div id="add-to-cart-message" class="alert alert-success text-center" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999;">
        Le produit a bien été ajouté au panier !
    </div>

    <div class="row">
        {% for product in product_object %}
        <div class="col-md-3 mb-4">
            <div class="card h-100">
                <img src="{{product.image.url}}" alt="" class="card-img-top">
                <div class="card-body d-flex flex-column">
                    <div id="aa{{product.id}}" class="card-title">{{product.title}}</div>
                    <div id="price{{product.id}}" style="color:orange" class="card-text"> {{product.price}} € </div>
                    <a href="{% url 'detail' product.id %}" class="btn btn-outline-warning btn-sm mt-auto">Voir</a>
                    <form method="post" action="{% url 'ajouter_au_panier' product.id %}" class="add-to-cart-form" data-product-id="{{ product.id }}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-success btn-sm">Ajouter au panier</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

<div class="row mt-3">
    <div class="col-md-12 d-flex justify-content-center">
        <ul class="pagination">
            {% if product_object.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ product_object.previous_page_number }}">Précédent</a>
            </li>
            {% endif %}
            {% for num in product_object.paginator.page_range %}
                {% if product_object.number == num %}
                    <li class="page-item active">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            {% if product_object.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ product_object.next_page_number }}">Suivant</a>
            </li>
            {% endif %}
        </ul>
    </div>
</div>
{% if request.GET.q %}
    <h4>Résultats pour « {{ request.GET.q }} »</h4>
{% endif %}
{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-to-cart-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var url = form.action;
            var formData = new FormData(form);
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var msg = document.getElementById('add-to-cart-message');
                    msg.style.display = 'block';
                    msg.textContent = 'Le produit a bien été ajouté au panier !';
                    setTimeout(function() {
                        msg.style.display = 'none';
                    }, 2000);
                }
            });
        });
    });
});
</script>
{% endblock %}
{% endblock %}

